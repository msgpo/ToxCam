machine:
  timezone:
    Europe/Berlin
  environment:
    MAKEFLAGS: ""
## ----------- RASPI cross compile ----------------
    RASPI_PATH: "/home/ubuntu/cc/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH"
    RASPI_SYSROOT_: "/home/ubuntu/cc/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/arm-linux-gnueabihf/sysroot"
    RASPI_TOOL_PREFIX: arm-linux-gnueabihf
    RASPI_INSTALL_DEST: "/home/ubuntu/installdest/"
    RASPI_TARGET_: arm-linux-gnueabi
    RASPI_HOST_: arm-linux-gnueabi
    RASPI_CXX: $RASPI_TOOL_PREFIX-g++
    RASPI_AR: $RASPI_TOOL_PREFIX-ar
    RASPI_RANLIB: $RASPI_TOOL_PREFIX-ranlib
    RASPI_CC: $RASPI_TOOL_PREFIX-gcc
    RASPI_LD: $RASPI_TOOL_PREFIX-ld
    RASPI_PKG_CONFIG_PATH: "/home/ubuntu/cc/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/arm-linux-gnueabihf/sysroot/usr/lib/pkgconfig"
    RASPI_s_: "/home/ubuntu/src/"
    RASPI_PKGSDIR: "/home/ubuntu/pkgs/"
## ----------- RASPI cross compile ----------------
    # ---------------------------------------------------
    # v0.1.10 more vpx tweaks        eab6e81ec9ed5b88aa712093ea53c802ff81d611
    # v0.1.10 lower init vbitrate    ac622abd1f6b8ff5122281e1e3f7053bcdb23fad
    # v0.1.10 cfg_dec2               3921fd04ee233a21befa960cf26214410e1b6582
    # v0.1.10 cfg_dec                94bf0a32adac079b7739c6d32cfc0e504993f962
    # v0.1.10 onlyKF    74dc53cf180e32f92ebb3cb5e8542e919cc3b343
    # v0.1.10 tweaks3   25d1fce22ddc87089cf53e9b3c5bcf9d56a57374
    # v0.1.10 mobtweaks f73b345c21fae0e0e56fae86dc82f63188a00aca
    # c-toxcore v0.1.9 a429ef4a28a5e5e0ad010efffb76d2abc3ada0af
    # c-toxcore v0.1.8 f6db9333e2d1262e7ba3846563c30f63c98ffa38
    # c-toxcore v0.1.7 48c86e942d487a8856cbd25797b320bfb1879ddc
    # c-toxcore v0.1.6 895de7ef26e7617769f2271345e414545c2581f8
    # c-toxcore v0.1.5 995578f1038842288c1ff552fd796ab2377db6e1
    # c-toxcore v0.1.4 27a97a8280813ec05a5209811c40ab23203bb292
    # c-toxcore v0.1.3 fdb46f6cf216a866d29402ae991be9c43282dde6
    # c-toxcore v0.1.2 a096c71db867ac83fc3e01e0fbe98573d20f9286
    # ---------------------------------------------------
    # c-toxcore version used
    # CTOXCORE_VERSION_HASH: master
    CTOXCORE_VERSION_HASH: "zoff99/_0.1.10_2017_video_fix_08"
    # c-toxcore repo used
    # CTOXCORE_URL: "https://github.com/TokTok/c-toxcore"
    CTOXCORE_URL: "https://github.com/zoff99/c-toxcore"
    LIBSODIUM_VERSION: "tags/1.0.13"
    LIBSODIUM_BRANCH: "1.0.13"
    OPUS_VERSION: "1.1.2"
    LIBVPX_VERSION: "v1.7.0"
    RASPBERRRY_TOOLS_HASH: d820ab9c21969013b4e56c7e9cba25518afcdd44
    
dependencies:
  pre:
    # -----------------------------------
    - sudo /etc/init.d/mysql stop ; exit 0
    - sudo /etc/init.d/postgresql stop ; exit 0
    # -----------------------------------
    - sudo apt-get update
    - sudo apt-get install cmake
    - aptitude search 4l|grep -i convert ; exit 0
    - aptitude search 4l|grep -i v4l ; exit 0
    - sudo apt-get install build-essential libtool autotools-dev automake checkinstall check git yasm libv4lconvert0 libv4l-dev
    - sudo apt-get install libopus-dev libvpx-dev pkg-config
    - sudo apt-get install libasound2-dev
    - sudo apt-get install linux-generic
    - sudo apt-get install libjpeg-dev
    - sudo apt-get install libpulse-dev
    - sudo apt-get install libconfig-dev
    - sudo apt-get install -y --no-install-recommends
      g++-mingw-w64-x86-64
      gcc-mingw-w64-x86-64
    - sudo apt-get install mingw-w64-tools binutils-mingw-w64-x86-64

    - sudo bash -c "echo '::1             localhost ipv6-localhost ipv6-loopback' >> /etc/hosts" # ipv6 localhost entry

    - gcc --version ; exit 0
    - clang --version ; exit 0
    - gcc-mingw-w64-x86-64 --version ; exit 0

    ### submodules ----------------
    - git submodule add --force https://github.com/TokTok/c-toxcore c-toxcore ; echo ok
    - git submodule add --force https://github.com/jedisct1/libsodium libsodium ; echo ok
    - git submodule init ; git submodule update ; echo ok
    # -- sometimes submodule can't find commit hash, whatever ------
    - rm -Rf c-toxcore ; git clone "$CTOXCORE_URL"
    # -- sometimes submodule can't find commit hash, whatever ------
    - cd c-toxcore/ ; git checkout "$CTOXCORE_VERSION_HASH"
    - cd libsodium/ ; git checkout $LIBSODIUM_VERSION
    ### submodules ----------------

    ### ------- compile and install libsodium -------
    - cd libsodium/ ; ./autogen.sh
    - cd libsodium/ ; ./configure && make check
    - cd libsodium/ ; sudo bash -c "printf 'y\naa\n\n' | checkinstall --install --pkgname libsodium --pkgversion 1.0.0 --nodoc --deldesc=no --pkglicense='GPL2'"
    - cd libsodium/ ; sudo ldconfig
    - cd libsodium ; sudo ldconfig -v 2>/dev/null | grep sodium
    ## --- now again to save the artefact ---
    - cd libsodium ; export INSTALL_DEST=/home/ubuntu/installdest_linux/ ; rm -Rf "$INSTALL_DEST"
    - cd libsodium ; export INSTALL_DEST=/home/ubuntu/installdest_linux/ ; mkdir -p  "$INSTALL_DEST"/usr ; ./configure --prefix="$INSTALL_DEST"/usr
    - cd libsodium ; export INSTALL_DEST=/home/ubuntu/installdest_linux/ ; make install ; ls -alR "$INSTALL_DEST"/usr
    - mkdir -p $CIRCLE_ARTIFACTS/ubuntu_14_04_binaries
    - export INSTALL_DEST=/home/ubuntu/installdest_linux/ ; cd "$INSTALL_DEST" ; tar -czvf $CIRCLE_ARTIFACTS/ubuntu_14_04_binaries/pkg_libsodium.tar.gz *
    ## --- now again to save the artefact ---
    ### ------- compile and install libsodium -------

    ### ------------ compile and install c-toxcore ------------
    - cd c-toxcore ; cmake -DWARNINGS=OFF .
    - cd c-toxcore ; make
    - cd c-toxcore ; sudo make install
    - cd c-toxcore ; sudo ldconfig -v 2>/dev/null | grep toxcore
    ## --- now again to save the artefact ---
    - cd c-toxcore ; export INSTALL_DEST=/home/ubuntu/installdest_linux/ ; rm -Rf "$INSTALL_DEST"
    - cd c-toxcore ; export INSTALL_DEST=/home/ubuntu/installdest_linux/ ; mkdir -p  "$INSTALL_DEST"/usr ; autoreconf -fi ; ./configure --enable-logging --disable-soname-versions --prefix="$INSTALL_DEST"/usr
    - cd c-toxcore ; export INSTALL_DEST=/home/ubuntu/installdest_linux/ ; make install ; ls -alR "$INSTALL_DEST"/usr
    - mkdir -p $CIRCLE_ARTIFACTS/ubuntu_14_04_binaries
    - export INSTALL_DEST=/home/ubuntu/installdest_linux/ ; cd "$INSTALL_DEST" ; tar -czvf $CIRCLE_ARTIFACTS/ubuntu_14_04_binaries/pkg_c-toxcore.tar.gz *
    ## --- now again to save the artefact ---
    ### ------------ run tests
    # - cd c-toxcore ; make test ARGS="-V" ; ex1=$? ; if [ $ex1 -ne 0 ]; then sleep 60; make test ARGS="-V" ; exit $? ; fi
    ### ------------ compile and install c-toxcore ------------




    ### ----------- win compile -----------
    - cd ~/ ; mkdir winbuild
    - cd ~/ ; mkdir win_cache
    ### ------- compile and install libsodium -------
    - cd ~/winbuild; git clone https://github.com/jedisct1/libsodium.git
    - cd ~/winbuild; cd libsodium ; git checkout "$LIBSODIUM_BRANCH"
    - cd ~/winbuild; cd libsodium ; ./autogen.sh
    - cd ~/winbuild; cd libsodium ;
      export TARGET_HOST="--host=x86_64-w64-mingw32" ;
      export TARGET_TRGT="--target=x86_64-win64-gcc" ;
      export CROSS="x86_64-w64-mingw32-" ;
      ./configure "$TARGET_HOST" --prefix=/home/ubuntu/win_cache/usr
    - cd ~/winbuild; cd libsodium ; make -j4
    - cd ~/winbuild; cd libsodium ; make install
    ### ------- compile and install libsodium -------

    ### ------- compile and install opus -------
    - cd ~/winbuild; git clone https://github.com/xiph/opus
    - cd ~/winbuild; cd opus ; git checkout "$OPUS_VERSION"
    - cd ~/winbuild; cd opus ; ./autogen.sh
    - cd ~/winbuild; cd opus ;
      export TARGET_HOST="--host=x86_64-w64-mingw32" ;
      export TARGET_TRGT="--target=x86_64-win64-gcc" ;
      export CROSS="x86_64-w64-mingw32-" ;
      export CFLAGS=" -g -O3 " ;
      export CXXFLAGS=" -g -O3 " ;
      ./configure "$TARGET_HOST" --prefix=/home/ubuntu/win_cache/usr
      --disable-extra-programs --disable-doc
    - cd ~/winbuild; cd opus ; make -j4
    - cd ~/winbuild; cd opus ; make install
    ### ------- compile and install opus -------

    ### ------- compile and install libvpx -------
    - cd ~/winbuild; git clone https://github.com/webmproject/libvpx.git
    - cd ~/winbuild; cd libvpx ; git checkout "$LIBVPX_VERSION"
    - cd ~/winbuild; cd libvpx ; ./autogen.sh ; exit 0 # sometime "configure" is already created
    - cd ~/winbuild; cd libvpx ;
      export TARGET_HOST="--host=x86_64-w64-mingw32" ;
      export TARGET_TRGT="--target=x86_64-win64-gcc" ;
      export CROSS="x86_64-w64-mingw32-" ;
      export CFLAGS=" -g -O3 " ;
      export CXXFLAGS=" -g -O3 " ;
      CROSS=x86_64-w64-mingw32- ./configure "$TARGET_TRGT"
      --prefix=/home/ubuntu/win_cache/usr
      --enable-static
      --size-limit=16384x16384
      --disable-shared
      --disable-unit-tests
      --enable-postproc
      --enable-multi-res-encoding
      --enable-temporal-denoising
      --enable-vp9-temporal-denoising
      --enable-vp9-postproc
    - cd ~/winbuild; cd libvpx ; make -j4
    - cd ~/winbuild; cd libvpx ; make install
    ### ------- compile and install libvpx -------

    ### ------- compile and install c-toxcore -------
    - cd ~/winbuild; git clone "$CTOXCORE_URL"
    - cd ~/winbuild; cd c-toxcore ; git checkout "$CTOXCORE_VERSION_HASH"
    - cd ~/winbuild; cd c-toxcore ; ./autogen.sh ; exit 0 # sometime "configure" is already created
    - cd ~/winbuild; cd c-toxcore ;
      export PKG_CONFIG_PATH="/home/ubuntu/win_cache/usr/lib/pkgconfig" ;
      export TARGET_HOST="--host=x86_64-w64-mingw32" ;
      export TARGET_TRGT="--target=x86_64-win64-gcc" ;
      export CROSS="x86_64-w64-mingw32-" ;
      export LIBSODIUM_CFLAGS=" -I/home/ubuntu/win_cache/usr/include/ "
      export LIBSODIUM_LIBS=" -L/home/ubuntu/win_cache/usr/lib/ -lsodium "
      export CFLAGS=" -g -O3 -I/home/ubuntu/win_cache/usr/include/ " ;
      export CXXFLAGS=" -g -O3 -I/home/ubuntu/win_cache/usr/include/ " ;
      CROSS=x86_64-w64-mingw32- ./configure "$TARGET_HOST" --prefix=/home/ubuntu/win_cache/usr
     --with-libsodium-headers=/home/ubuntu/win_cache/usr/include/ --with-libsodium-libs=/home/ubuntu/win_cache/usr/lib/
     --disable-soname-versions --disable-shared
    - cd ~/winbuild; cd c-toxcore ; make VERBOSE=1 V=1
    - cd ~/winbuild; cd c-toxcore ; make install
    ### ------- compile and install c-toxcore -------

    - cd ~/winbuild/ ; cp -av ~/ToxCam ./
    - cd ~/winbuild/ToxCam/toxcam/ ;
      x86_64-w64-mingw32-gcc -O3 -g
      -L/home/ubuntu/win_cache/usr/lib
      -I/home/ubuntu/win_cache/usr/include/
      -o toxcam.exe toxcam.c rb.c -std=gnu99
      -lm
      -ltoxcore -ltoxav -ltoxdns -ltoxencryptsave
      -lws2_32 -liphlpapi
      /home/ubuntu/win_cache/usr/lib/libvpx.a
      /home/ubuntu/win_cache/usr/lib/libopus.a
      /home/ubuntu/win_cache/usr/lib/libsodium.a
      -static -lpthread

    - cd ~/winbuild/ToxCam/toxcam/ ; ls -al toxcam.exe
    - mkdir -p $CIRCLE_ARTIFACTS/win_binaries/
    - cd ~/winbuild/ToxCam/toxcam/ ; cp -av toxcam.exe $CIRCLE_ARTIFACTS/win_binaries/
    ### ----------- win compile -----------

test:
  override:
    - cd toxcam ; rm -fv toxcam toxcam_static
    - cd toxcam ; gcc -O3 -g -fPIC -o toxcam toxcam.c rb.c -std=gnu99 -lsodium -I/usr/local/include/ -lm -ltoxcore -ltoxav -lpthread -lvpx -lv4lconvert # -lasound
    - cd toxcam ; ldd toxcam ; exit 0
    - find / -name '*libjpeg*' 2> /dev/null ; exit 0
    - cd toxcam ; gcc -O3 -g -Wall -o toxcam_static toxcam.c rb.c -static -std=gnu99 -L/usr/local/lib -I/usr/local/include/ -lsodium -ltoxcore -ltoxav -ltoxgroup -ltoxmessenger -ltoxfriends -ltoxnetcrypto -ltoxdht -ltoxnetwork -ltoxcrypto -lsodium -lpthread -static-libgcc -static-libstdc++ -lopus -lvpx -lm -lpthread -lv4lconvert -ljpeg -lm -lrt # -lasound
    - cd toxcam ; ls -al toxcam toxcam_static
    - mkdir -p $CIRCLE_ARTIFACTS/ubuntu_14_04_binaries/
    - cp -av toxcam/toxcam $CIRCLE_ARTIFACTS/ubuntu_14_04_binaries/
    - cp -av toxcam/toxcam_static $CIRCLE_ARTIFACTS/ubuntu_14_04_binaries/
